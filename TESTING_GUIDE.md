# دليل اختبار نظام كشف تسلسل الآيات

## نظرة عامة
هذا الدليل يوضح كيفية اختبار نظام كشف تسلسل الآيات للتأكد من عمله بشكل صحيح.

## الإعداد للاختبار

### 1. تشغيل الخادم
```bash
python run.py
```

### 2. فتح المتصفح
افتح `http://localhost:7860` في المتصفح

### 3. اختيار صفحة للاختبار
اختر صفحة تحتوي على عدة آيات (مثلاً صفحة 2 من سورة البقرة)

## سيناريوهات الاختبار

### السيناريو 1: التسميع الصحيح (لا يجب ظهور تنبيهات)

**الخطوات:**
1. اضغط على "بدء التسميع"
2. اقرأ الآيات بالترتيب الصحيح من بداية الصفحة
3. اقرأ كل آية كاملة بدون تخطي

**النتيجة المتوقعة:**
- الكلمات تظهر تدريجياً باللون الأخضر
- لا تظهر أي رسائل تحذير
- لا يتم تلوين أي آيات باللون الأصفر

---

### السيناريو 2: تخطي آية واحدة

**مثال من سورة البقرة (صفحة 2):**

**الترتيب الصحيح:**
```
الآية 6: إِنَّ الَّذِينَ كَفَرُوا سَوَاءٌ عَلَيْهِمْ أَأَنذَرْتَهُمْ أَمْ لَمْ تُنذِرْهُمْ لَا يُؤْمِنُونَ
الآية 7: خَتَمَ اللَّهُ عَلَىٰ قُلُوبِهِمْ وَعَلَىٰ سَمْعِهِمْ ۖ وَعَلَىٰ أَبْصَارِهِمْ غِشَاوَةٌ ۖ وَلَهُمْ عَذَابٌ عَظِيمٌ
الآية 8: وَمِنَ النَّاسِ مَن يَقُولُ آمَنَّا بِاللَّهِ وَبِالْيَوْمِ الْآخِرِ وَمَا هُم بِمُؤْمِنِينَ
```

**ما يجب فعله:**
1. اقرأ الآية 6 كاملة
2. **تخطى الآية 7 تماماً**
3. اقرأ الآية 8 مباشرة

**النتيجة المتوقعة:**
- تظهر رسالة تحذير صفراء: "تم تخطي الآية رقم 7. يرجى إعادة التلاوة من الموضع الصحيح."
- الآية 7 تُلوّن باللون الأصفر مع تأثير نبض
- يمكن إغلاق الرسالة بالضغط على ×
- التسميع يستمر بدون توقف

---

### السيناريو 3: تخطي عدة آيات

**مثال:**

**الترتيب الصحيح:**
```
الآية 10: فِي قُلُوبِهِم مَّرَضٌ فَزَادَهُمُ اللَّهُ مَرَضًا ۖ وَلَهُمْ عَذَابٌ أَلِيمٌ بِمَا كَانُوا يَكْذِبُونَ
الآية 11: وَإِذَا قِيلَ لَهُمْ لَا تُفْسِدُوا فِي الْأَرْضِ قَالُوا إِنَّمَا نَحْنُ مُصْلِحُونَ
الآية 12: أَلَا إِنَّهُمْ هُمُ الْمُفْسِدُونَ وَلَٰكِن لَّا يَشْعُرُونَ
الآية 13: وَإِذَا قِيلَ لَهُمْ آمِنُوا كَمَا آمَنَ النَّاسُ قَالُوا أَنُؤْمِنُ كَمَا آمَنَ السُّفَهَاءُ...
الآية 14: وَإِذَا لَقُوا الَّذِينَ آمَنُوا قَالُوا آمَنَّا...
```

**ما يجب فعله:**
1. اقرأ الآية 10 كاملة
2. اقرأ الآية 11 كاملة
3. **تخطى الآيات 12 و 13 تماماً**
4. اقرأ الآية 14 مباشرة

**النتيجة المتوقعة:**
- تظهر رسالة: "تم تخطي الآيات من 12 إلى 13. يرجى إعادة التلاوة من الموضع الصحيح."
- الآيات 12 و 13 تُلوّن باللون الأصفر
- عداد الأخطاء يزيد

---

### السيناريو 4: القراءة من صفحة مختلفة

**ما يجب فعله:**
1. افتح صفحة 3 في النظام
2. اضغط "بدء التسميع"
3. اقرأ آيات من صفحة 5 أو أي صفحة أخرى

**النتيجة المتوقعة:**
- بعد 2-3 تشَنكات (4-6 ثواني)
- تظهر رسالة خطأ حمراء: "التلاوة الحالية لا تطابق آيات هذه الصفحة. تأكد أنك تقرأ من نفس الموضع."
- الرسالة تبقى حتى يتم إغلاقها يدوياً

---

### السيناريو 5: الرجوع للخلف

**ما يجب فعله:**
1. اقرأ الآيات 6، 7، 8، 9، 10 بالترتيب
2. ثم ارجع واقرأ الآية 6 مرة أخرى

**النتيجة المتوقعة:**
- قد تظهر رسالة تحذير: "تم الرجوع للخلف بمقدار X كلمة. قد يكون هناك خلط في التلاوة."
- هذا يعتمد على `SEQUENCE_BACKWARDS_TOLERANCE` في الإعدادات

---

## فحص السجلات (Logs)

### في Terminal/Console
راقب السجلات للتحقق من عمل النظام:

```
[abc12345] Sequence error detected: skip_aya - تم تخطي الآيات من 12 إلى 13
[abc12345] Chunk processed successfully. New position: 245
```

### في Browser Console (F12)
```javascript
Sequence error detected: {type: "skip_aya", severity: "warning", ...}
Skip detected: Ayas 12 to 13 were skipped
```

---

## ضبط الحساسية للاختبار

### إذا لم تُكتشف القفزات
عدّل في `backend/config.py`:

```python
SEQUENCE_SKIP_MIN_WORDS = 8  # كان 12
SEQUENCE_ALERT_MIN_CONFIDENCE = 0.4  # كان 0.5
```

### إذا ظهرت إنذارات كاذبة كثيرة
```python
SEQUENCE_SKIP_MIN_WORDS = 15  # كان 12
SEQUENCE_ALERT_MIN_CONFIDENCE = 0.6  # كان 0.5
```

---

## معايير النجاح

### ✅ النظام يعمل بشكل صحيح إذا:

1. **التسميع الصحيح**: لا تظهر تنبيهات عند القراءة بالترتيب الصحيح
2. **كشف القفز**: يكتشف تخطي آية واحدة أو أكثر بدقة ≥80%
3. **كشف عدم التطابق**: يكتشف القراءة من صفحة مختلفة خلال 5-10 ثواني
4. **التلوين البصري**: الآيات المتخطّاة تُلوّن باللون الأصفر بوضوح
5. **الرسائل واضحة**: التنبيهات مفهومة وبالعربية
6. **عدم التوقف**: التسميع يستمر حتى مع وجود أخطاء

### ❌ مشاكل محتملة:

1. **إنذارات كاذبة كثيرة**: قلل الحساسية (زد `SEQUENCE_SKIP_MIN_WORDS`)
2. **لا يكتشف القفزات**: زد الحساسية (قلل `SEQUENCE_SKIP_MIN_WORDS`)
3. **لا تظهر الرسائل**: تحقق من console للأخطاء في JavaScript
4. **الألوان لا تظهر**: تحقق من `style.css` وأن الكلاسات تُطبّق بشكل صحيح

---

## اختبار الأداء

### قياس زمن الاستجابة
راقب في السجلات:
```
[abc12345] Chunk processed successfully. Total time: 0.847s
```

**الأهداف:**
- زمن معالجة < 1 ثانية لكل تشَنك
- كشف القفز خلال 2-3 ثواني من حدوثه

### اختبار مع صوت حقيقي
1. استخدم ميكروفون جيد
2. اقرأ بصوت واضح
3. تجنب الضوضاء في الخلفية
4. جرّب سرعات قراءة مختلفة

---

## الإبلاغ عن المشاكل

عند الإبلاغ عن مشكلة، يرجى تضمين:

1. **السيناريو**: ماذا كنت تفعل؟
2. **النتيجة المتوقعة**: ماذا كان يجب أن يحدث؟
3. **النتيجة الفعلية**: ماذا حدث بالفعل؟
4. **السجلات**: نسخ من console و terminal
5. **الإعدادات**: قيم `config.py` المستخدمة
6. **نموذج ASR**: هل تستخدم Whisper أم NeMo؟

---

## نصائح للاختبار الفعّال

1. **ابدأ بسيط**: اختبر تخطي آية واحدة أولاً
2. **تدرّج**: ثم جرّب سيناريوهات أكثر تعقيداً
3. **سجّل الصوت**: احفظ تسجيلات الاختبار لإعادة الاختبار
4. **قارن النماذج**: جرّب Whisper و NeMo لمقارنة الأداء
5. **اختبر على أجهزة مختلفة**: كمبيوتر، موبايل، تابلت

